name: Build and Push Docker Image, Then Update GitOps

env:
  PROJECT_NAME: "redpanda-producer-api"
  
on:
  push:
    tags:
      - "*"          # change to 'v*' if you only want versioned tags

jobs:
  build-and-push:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag (use Git tag)
        id: set-tag
        run: echo "image_tag=ghcr.io/fabiossena/${{ env.PROJECT_NAME }}:${{ github.ref_name }}" >> "$GITHUB_OUTPUT" 

      - name: Build Docker image
        run: docker build -t "${{ steps.set-tag.outputs.image_tag }}" .

      - name: Push Docker image
        run: docker push "${{ steps.set-tag.outputs.image_tag }}"

  update-gitops:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: fabiossena/gitops-v2
          token: ${{ secrets.GITOPS_CLASSIC_TOKEN }}
          ref: main
          path: gitops-v2

      - name: Update image in Kustomize (production)
        run: |
          cd gitops-v2/overlays/production
          kustomize edit set image ghcr.io/fabiossena/${{ env.PROJECT_NAME }}=${{ needs.build-and-push.outputs.image_tag }}

      - name: Build Kustomize output (dry run)
        run: |
          cd gitops-v2/overlays/production
          kustomize build .

      - name: Commit and push changes
        run: |
          cd gitops-v2
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add overlays/production/kustomization.yaml
          git commit -m "chore: update ${{ env.PROJECT_NAME }} image to ${{ needs.build-and-push.outputs.image_tag }}" || echo "No changes to commit"
          git push origin main

